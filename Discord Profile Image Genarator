import requests
import json
import urllib
from tkinter import Tk, Label, Entry, Button, Text, messagebox, filedialog
from PIL import Image, ImageTk
from io import BytesIO

def generate_image_from_text(prompt, negative_prompt, api_key):
    response = requests.post(
        'https://api.kakaobrain.com/v2/inference/karlo/t2i',
        json={
            'prompt': prompt,
            'negative_prompt': negative_prompt
        },
        headers={
            'Authorization': f'KakaoAK {api_key}',
            'Content-Type': 'application/json'
        }
    )
    if response.status_code == 200:
        response_data = json.loads(response.content)
        image_url = response_data.get("images")[0].get("image")
        return image_url
    else:
        raise Exception("Error in API call: " + response.text)

def download_image(image, filename):
    if filename:
        image.save(filename)
        messagebox.showinfo("Success", f"Image saved as {filename}")
    else:
        messagebox.showinfo("Cancelled", "Image download cancelled")

def download_and_show_image(image_url):
    with urllib.request.urlopen(image_url) as url:
        image = Image.open(BytesIO(url.read()))
        tk_image = ImageTk.PhotoImage(image)
        image_label.config(image=tk_image)
        image_label.image = tk_image  # 이미지 레퍼런스 보존
        download_button.config(command=lambda: save_image(image))

def save_image(image):
    filetypes = [('JPEG', '*.jpg'), ('PNG', '*.png'), ('All files', '*.*')]
    filename = filedialog.asksaveasfilename(title="Save Image", filetypes=filetypes, defaultextension=filetypes)
    download_image(image, filename)

def on_generate():
    prompt = prompt_text.get("1.0","end-1c")
    negative_prompt = negative_prompt_text.get("1.0","end-1c")
    if prompt:
        try:
            image_url = generate_image_from_text(prompt, negative_prompt, api_key)
            download_and_show_image(image_url)
        except Exception as e:
            messagebox.showerror("Error", str(e))
    else:
        messagebox.showinfo("Information", "Please enter some text")

# API 키 설정
api_key = "42586769cdf144c66dd55fab903e76a4"  # 여기에 실제 카카오 API 키를 입력하세요

# UI 생성
root = Tk()
root.title("Kakao Kalro 2.0 Image Generator")

Label(root, text="Prompt:").pack()
prompt_text = Text(root, height=4, width=40)
prompt_text.pack()

Label(root, text="Negative Prompt:").pack()
negative_prompt_text = Text(root, height=4, width=40)
negative_prompt_text.pack()

generate_button = Button(root, text="Generate Image", command=on_generate)
generate_button.pack()

image_label = Label(root)
image_label.pack()

download_button = Button(root, text="Download Image")
download_button.pack()

if __name__ == "__main__":
    root.mainloop()
